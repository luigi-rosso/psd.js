/** @license psd.js 2012 - imaya [ https://github.com/imaya/psd.js ] The MIT License */
(function() {'use strict';function f(){return function(){}}var i=this;function k(a,b){var c=a.split("."),d=i;!(c[0]in d)&&d.execScript&&d.execScript("var "+c[0]);for(var e;c.length&&(e=c.shift());)!c.length&&void 0!==b?d[e]=b:d=d[e]?d[e]:d[e]={}}function l(a,b){function c(){}c.prototype=b.prototype;a.superClass_=b.prototype;a.prototype=new c;a.prototype.constructor=a};var m=void 0!==i.Uint8Array&&void 0!==i.Uint16Array&&void 0!==i.Uint32Array;function n(){}n.prototype.parse=function(a,b){var c;this.offset=a.ip;this.signature=q(a,4);this.key=q(a,4);c=t(a);this.length=c+12;"function"===typeof n[this.key]?(this.info=new n[this.key],this.info.parse(a,c,b)):console.warn("additional layer information: not implemented",this.key);a.seek(this.offset+this.length,0)};var u={};u.bevl={};u.bevl=f();
u.bevl.prototype.parse=function(a){this.offset=a.ip;this.size=t(a);this.version=t(a);this.angle=v(a);this.strength=v(a);this.blur=v(a);this.highlightBlendModeSignature=q(a,4);this.highlightBlendModeKey=q(a,4);this.shadowBlendModeSignature=q(a,4);this.shadowBlendModeKey=q(a,4);a.seek(2);this.highlightColor=[t(a),t(a)];a.seek(2);this.shadowColor=[t(a),t(a)];this.bevelStyle=z(a);this.highlightOpacity=z(a);this.shadowOpacity=z(a);this.enabled=!!z(a);this.use=!!z(a);this.up=!!z(a);2===this.version&&(a.seek(2),
this.readHighlightColor=[t(a),t(a)],a.seek(2),this.readShadowColor=[t(a),t(a)]);this.length=a.ip-this.offset};u.cmnS={};u.cmnS=f();u.cmnS.prototype.parse=function(a){this.offset=a.ip;this.size=t(a);this.version=t(a);this.visible=!!z(a);a.seek(2);this.length=a.ip-this.offset};u.dsdw={};u.dsdw=f();u.dsdw.prototype.parse=function(a){this.offset=a.ip;this.size=t(a);this.version=t(a);this.blur=v(a);this.intensity=v(a);this.angle=v(a);this.distance=v(a);a.seek(2);this.color=[t(a),t(a)];this.signature=q(a,4);this.blend=q(a,4);this.enabled=!!z(a);this.use=!!z(a);this.opacity=z(a);a.seek(2);this.nativeColor=[t(a),t(a)];this.length=a.ip-this.offset};u.iglw={};u.iglw=f();u.iglw.prototype.parse=function(a){this.offset=a.ip;this.size=t(a);this.version=t(a);this.blur=v(a);this.intensity=v(a);a.seek(2);this.color=[t(a),t(a)];this.signature=q(a,4);this.blend=q(a,4);this.enabled=!!z(a);this.opacity=z(a);2===this.version&&(this.invert=!!z(a),a.seek(2),this.nativeColor=[t(a),t(a)]);this.length=a.ip-this.offset};u.isdw={};u.isdw=u.dsdw;u.oglw={};u.oglw=f();u.oglw.prototype.parse=function(a){this.offset=a.ip;this.size=t(a);this.version=t(a);this.blur=v(a);this.intensity=v(a);a.seek(2);this.color=[t(a),t(a)];this.signature=q(a,4);this.blend=q(a,4);this.enabled=!!z(a);this.opacity=z(a);2===this.version&&(a.seek(2),this.nativeColor=[t(a),t(a)]);this.length=a.ip-this.offset};u.sofi={};u.sofi=f();u.sofi.prototype.parse=function(a){var b;this.offset=a.ip;this.size=t(a);this.version=t(a);b=q(a,4);if("8BIM"!==b)throw Error("invalid signature:",b);this.blend=q(a,4);a.seek(2);this.color=[A(a)>>8,A(a)>>8,A(a)>>8,A(a)>>8];this.opacity=z(a);this.enabled=!!z(a);a.seek(2);this.nativeColor=[C(a)>>8,C(a)>>8,C(a)>>8,C(a)>>8];this.length=a.ip-this.offset};n.Patt=f();n.Patt.prototype.parse=function(a,b,c){b=a.ip+b;for(this.offset=a.ip;a.ip<b;)t(a),t(a),v(a),C(a),C(a),D(a,t(a)),q(a,a.input[a.ip++]),c.colorMode===E&&F(a,768),F(a,b-this.offset);this.length=a.ip-this.offset};n.PlLd=f();
n.PlLd.prototype.parse=function(a){this.offset=a.ip;this.type=q(a,4);if("plcL"!==this.type)throw Error("invalid type:",this.type);this.version=t(a);this.id=q(a,a.input[a.ip++]);this.page=v(a);this.totalPage=v(a);this.antiAlias=v(a);this.placedLayerType=v(a);this.transform=[a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64()];this.warpVersion=v(a);this.warpDescriptorVersion=v(a);this.descriptor=new G;this.descriptor.parse(a);this.length=
a.ip-this.offset};n.SoLd=f();n.SoLd.prototype.parse=function(a){this.offset=a.ip;this.identifier=q(a,4);if("soLD"!==this.identifier)throw Error("invalid identifier:",this.identifier);this.version=t(a);this.descriptorVersion=v(a);this.descriptor=new G;this.descriptor.parse(a);this.length=a.ip-this.offset};n.TySh=f();
n.TySh.prototype.parse=function(a){this.offset=a.ip;this.version=C(a);this.transform=[a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64(),a.readFloat64()];this.textVersion=C(a);this.textDescriptorVersion=v(a);this.textData=new G;this.textData.parse(a);this.textData.items!==this.textData.item.length?console.error("Descriptor parsing failed"):(this.warpVersion=C(a),this.warpDescriptorVersion=v(a),this.warpData=new G,this.warpData.parse(a),console.log("TySh implementation is incomplete"),this.left=
v(a),this.top=v(a),this.right=v(a),this.bottom=v(a),this.length=a.ip-this.offset)};n.clbl=f();n.clbl.prototype.parse=function(a){this.offset=a.ip;this.blendClippedElements=!!z(a);a.seek(3);this.length=a.ip-this.offset};n.fxrp=f();n.fxrp.prototype.parse=function(a){this.offset=a.ip;this.referencePoint=[a.readFloat64(),a.readFloat64()];this.length=a.ip-this.offset};n.iOpa=f();n.iOpa.prototype.parse=function(a){this.offset=a.ip;this.opacity=z(a);a.seek(3);this.length=a.ip-this.offset};n.infx=f();n.infx.prototype.parse=function(a){this.offset=a.ip;this.blendInteriorElements=!!z(a);a.seek(3);this.length=a.ip-this.offset};n.knko=f();n.knko.prototype.parse=function(a){this.offset=a.ip;this.knockout=!!z(a);a.seek(3);this.length=a.ip-this.offset};n.lclr=f();n.lclr.prototype.parse=function(a){this.offset=a.ip;this.color=[t(a),t(a)];this.length=a.ip-this.offset};n.lfx2=f();n.lfx2.prototype.parse=function(a){this.offset=a.ip;this.version=t(a);this.descriptorVersion=t(a);this.descriptor=new G;this.descriptor.parse(a);this.length=a.ip-this.offset};n.lnsr=f();n.lnsr.prototype.parse=function(a){this.offset=a.ip;this.id=q(a,4);this.length=a.ip-this.offset};n.lrFX=f();n.lrFX.prototype.parse=function(a){var b,c,d;this.offset=a.ip;this.version=A(a);this.count=A(a);this.effect=[];for(d=0;d<this.count;++d){b=q(a,4);if("8BIM"!==b){console.warn("invalid signature:",b);break}this.key=b=q(a,4);if("function"===typeof u[this.key])c=new u[this.key],c.parse(a),this.effect[d]={key:b,effect:c};else{console.warn("detect unknown key:",b);break}}this.length=a.ip-this.offset};n.lsct=f();n.lsct.prototype.parse=function(a,b){var c;this.offset=a.ip;this.type=t(a);if(12===b){c=q(a,4);if("8BIM"!==c)throw Error("invalid section divider setting signature:",c);this.key=q(a,4)}this.length=a.ip-this.offset};n.lspf=f();n.lspf.prototype.parse=function(a){this.offset=a.ip;this.flags=t(a);this.length=a.ip-this.offset};n.luni=f();n.luni.prototype.parse=function(a){var b;this.offset=a.ip;b=t(a);this.layerName=D(a,b);1===(b&1)&&a.seek(2);this.length=a.ip-this.offset};n.lyid=f();n.lyid.prototype.parse=function(a){this.offset=a.ip;this.layerId=t(a);this.length=a.ip-this.offset};n.lyvr=f();n.lyvr.prototype.parse=function(a){this.offset=a.ip;this.version=t(a);this.length=a.ip-this.offset};n.shmd=f();n.shmd.prototype.parse=function(a){var b,c,d,e,g=this.metadata=[],j,h;this.offset=a.ip;this.items=t(a);j=0;for(h=this.items;j<h;++j)b=q(a,4),c=q(a,4),d=z(a),a.seek(3),e=t(a),e=F(a,e),g[j]={signature:b,key:c,copy:d,data:e};this.length=a.ip-this.offset};n.vmsk=f();n.vmsk.prototype.parse=function(a,b){var c=a.ip+b;this.offset=a.ip;this.version=t(a);for(this.flags=t(a);a.ip+26<=c;)this.path=new H,this.path.parse(a);this.length=a.ip-this.offset};function I(){};function G(){}G.prototype.parse=function(a){var b,c,d,e;this.offset=a.ip;b=t(a);this.name=D(a,b);b=t(a)||4;this.classId=q(a,b);this.items=t(a);this.item=[];d=0;for(e=this.items;d<e;++d){b=t(a)||4;b=q(a,b);c=q(a,4);if("function"!==typeof G[c]){console.warn("OSType Key not implemented:",c);break}c=new G[c];c.parse(a);this.item.push({key:b,data:c})}this.length=a.ip-this.offset};n.GdFl=f();n.GdFl.prototype.parse=function(a){this.offset=a.ip;this.version=t(a);this.descriptor=new G;this.descriptor.parse(a);this.length=a.ip-this.offset};n.SoCo=f();n.SoCo.prototype.parse=function(a){this.offset=a.ip;this.version=t(a);this.descriptor=new G;this.descriptor.parse(a);this.length=a.ip-this.offset};G.ObAr=f();G.ObAr.prototype.parse=function(a){this.offset=a.ip;console.warn("OSType key not implemented (undocumented): ObAr(ObjectArray?)");this.length=a.ip-this.offset};G.Objc=f();G.Objc.prototype.parse=function(a){this.offset=a.ip;this.value=new G;this.value.parse(a);this.length=a.ip-this.offset};G.GlbO=G.Objc;G.TEXT=f();G.TEXT.prototype.parse=function(a){var b;this.offset=a.ip;b=t(a);this.string=D(a,b);this.length=a.ip-this.offset};G.UnFl=f();G.UnFl.prototype.parse=function(a){var b=this.value=[],c,d;this.offset=a.ip;this.key=q(a,4);c=t(a);for(d=0;d<c;++d)b[d]=a.readFloat64();this.length=a.ip-this.offset};G.UntF=f();G.UntF.prototype.parse=function(a){this.offset=a.ip;this.units=q(a,4);this.value=a.readFloat64();this.length=a.ip-this.offset};G.VlLs=f();G.VlLs.prototype.parse=function(a){var b,c,d,e;this.offset=a.ip;this.item=[];b=t(a);for(c=0;c<b;++c){d=q(a,4);if("function"!==typeof G[d]){console.error("OSType Key not implemented:",d);return}e=new G[d];e.parse(a);this.item.push({type:d,data:e})}this.length=a.ip-this.offset};G.alis=f();G.alis.prototype.parse=function(a){var b;this.offset=a.ip;b=t(a);this.value=F(a,b);this.length=a.ip-this.offset};G.bool=f();G.bool.prototype.parse=function(a){this.offset=a.ip;this.value=!!z(a);this.length=a.ip-this.offset};G.doub=f();G.doub.prototype.parse=function(a){this.offset=a.ip;this.value=a.readFloat64();this.length=a.ip-this.offset};G["enum"]=f();G["enum"].prototype.parse=function(a){var b;this.offset=a.ip;b=t(a);0===b&&(b=4);this.type=q(a,b);b=t(a);0===b&&(b=4);this.enum=q(a,b);this.length=a.ip-this.offset};G["long"]=f();G["long"].prototype.parse=function(a){this.offset=a.ip;this.value=v(a);this.length=a.ip-this.offset};G["obj "]=f();G["obj "].prototype.parse=function(a){var b,c,d,e;this.offset=a.ip;this.item=[];b=this.items=t(a);for(e=0;e<b;++e){c=q(a,4);d=G["obj "].Table[c];if("function"!==typeof G[d]){console.error("OSType Key not implemented:",d);return}d=new G[d];d.parse(a);this.item.push({key:c,data:d})}this.length=a.ip-this.offset};G["obj "].Table={prop:"prop",Clss:"type",Enmr:"enum",rele:"rele",Idnt:"long",indx:"long",name:"TEXT"};G.prop=f();G.prop.prototype.parse=function(a){var b;this.offset=a.ip;b=t(a);this.name=D(a,b);b=t(a)||4;this.classId=q(a,b);b=t(a)||4;this.keyId=q(a,b);this.length=a.ip-this.offset};G.rele=f();G.rele.prototype.parse=function(a){var b;this.offset=a.ip;b=t(a);this.name=D(a,b);b=t(a)||4;this.classId=q(a,b);this.value=t(a);this.length=a.ip-this.offset};G.tdta=f();G.tdta.prototype.parse=function(a){var b;this.offset=a.ip;b=t(a);this.data=F(a,b);this.length=a.ip-this.offset};G.type=f();G.type.prototype.parse=function(a){var b;this.offset=a.ip;b=t(a);this.name=D(a,b);b=t(a)||4;this.classId=q(a,b);this.length=a.ip-this.offset};G.GlbC=G.type;var E=2;function J(){};function K(){this.channel=[]}K.prototype.parse=function(a){var b;this.offset=a.ip;this.length=t(a)+4;if(4===this.length)console.log("skip: layer blending ranges(empty body)");else{b=this.offset+this.length;this.black=A(a);this.white=A(a);for(this.destRange=t(a);a.ip<b;)this.channel.push([t(a),t(a)])}};function H(){}H.prototype.parse=function(a){this.offset=a.ip;this.type=C(a);a.seek(26,this.offset);this.length=a.ip-this.offset};function L(a,b){this.input=m?new Uint8Array(a):a;this.ip=b|0}function t(a){return(a.input[a.ip++]<<24|a.input[a.ip++]<<16|a.input[a.ip++]<<8|a.input[a.ip++])>>>0}function v(a){return a.input[a.ip++]<<24|a.input[a.ip++]<<16|a.input[a.ip++]<<8|a.input[a.ip++]}function A(a){return a.input[a.ip++]<<8|a.input[a.ip++]}function C(a){return(a.input[a.ip++]<<8|a.input[a.ip++])<<16>>16}function z(a){return a.input[a.ip++]}var aa=L.prototype;
if(m)var M=new ArrayBuffer(8),ba=new Uint8Array(M),ca=new Float64Array(M);else var da=Math.pow(2,48),ea=Math.pow(2,40),fa=Math.pow(2,32),ga=Math.pow(2,24),ha=Math.pow(2,16),ia=Math.pow(2,8),ja=Math.pow(2,-1022),ka=Math.pow(2,-52);
aa.readFloat64=function(){var a;if(m){a=this.input;for(var b=this.ip,c=8;--c;)ba[c]=a[b++];a=ca[0]}else{var c=this.input,d=this.ip;a=0===(c[d]&128);b=(c[d++]&127)<<4|(c[d]&240)>>4;c=(c[d++]&15)*da+c[d++]*ea+c[d++]*fa+c[d++]*ga+c[d++]*ha+c[d++]*ia+c[d++];a=0===b?0===c?0:(a?1:-1)*ja*c*ka:2047===b?c?NaN:a?Infinity:-Infinity:(a?1:-1)*(Math.pow(2,b-1023)+c*Math.pow(2,b-1075))}this.ip+=8;return a};function F(a,b){return m?a.input.subarray(a.ip,a.ip+=b):a.input.slice(a.ip,a.ip+=b)}
L.prototype.slice=function(a,b){this.ip=b;return m?this.input.subarray(a,b):this.input.slice(a,b)};L.prototype.fetch=function(a,b){return m?this.input.subarray(a,b):this.input.slice(a,b)};function q(a,b){var c=a.input,d=a.ip,e=[],g;for(g=0;g<b;++g)e[g]=String.fromCharCode(c[d++]);a.ip=d;return e.join("")}function D(a,b){var c=a.input,d=a.ip,e=[],g;for(g=0;g<b;++g)e[g]=String.fromCharCode(c[d++]<<8|c[d++]);a.ip=d;return e.join("")}
L.prototype.seek=function(a,b){"number"!==typeof b&&(b=this.ip);this.ip=b+a};function N(a,b){var c,d,e,g=[],j=0;for(c=a.ip+b;a.ip<c;)if(d=a.input[a.ip++]<<24>>24,0>d){d=1-d;for(e=z(a);0<d--;)g[j++]=e}else for(d=1+d;0<d--;)g[j++]=z(a);return g};function O(){}O.prototype.parse=function(a){this.offset=a.ip;this.length=t(a)+4;this.overlayColorSpace=A(a);this.colorComponents=[A(a),A(a),A(a),A(a)];this.opacity=A(a);this.kind=z(a);this.filter=F(a,this.offset+this.length-a.ip);a.seek(this.offset+this.length,0)};function P(){}P.prototype.parse=function(a){this.offset=a.ip;this.signature=q(a,4);if("8BPS"!==this.signature)throw Error("invalid signature");this.version=A(a);this.reserved=F(a,6);this.channels=A(a);this.rows=t(a);this.columns=t(a);this.depth=A(a);this.colorMode=A(a);this.length=a.ip-this.offset};function Q(a,b,c){this.header=a;this.colorModeData=b;this.channel=c;this.parsed=!1}
Q.prototype.parse=function(){switch(this.header.colorMode){case 0:console.error("bitmap color mode not supported");break;case 8:console.warn("duotone color mode implementation is incomplete");case 1:var a=this.channel[0],b,c=a.length,d=this.redChannel=new (m?Uint8Array:Array)(c),e=this.greenChannel=new (m?Uint8Array:Array)(c),g=this.blueChannel=new (m?Uint8Array:Array)(c),j=this.header.depth/8,h;for(b=h=0;b<c;++h,b+=j)d[h]=e[h]=g[h]=a[b];break;case E:a=this.channel[0];c=a.length;e=this.redChannel=
new (m?Uint8Array:Array)(c);g=this.greenChannel=new (m?Uint8Array:Array)(c);j=this.blueChannel=new (m?Uint8Array:Array)(c);h=this.colorModeData.data;var s=h.length/3;for(b=d=0;b<c;++d,b+=1)e[d]=h[a[b]],g[d]=h[a[b]+s],j[d]=h[a[b]+2*s];break;case 7:console.warn("multichannel color mode implementation is incomplete");case 3:a=this.redChannel=this.channel[0];b=this.greenChannel=this.channel[1];c=this.blueChannel=this.channel[2];this.alphaChannel=this.channel[3];e=this.header.depth/8;if(1!==e){if(4===
this.channel.length){d=this.alphaChannel=this.channel[3];g=h=0;for(j=a.length;g<j;++h,g+=e)a[h]=a[g],b[h]=b[g],c[h]=c[g],d[h]=d[g]}else{g=h=0;for(j=a.length;g<j;++h,g+=e)a[h]=a[g],b[h]=b[g],c[h]=c[g]}m?(this.redChannel=a.subarray(0,h),this.greenChannel=b.subarray(0,h),this.blueChannel=c.subarray(0,h)):a.length=b.length=c.length=h;4===this.channel.length&&(m?this.alphaChannel=d.subarray(0,h):d.length=h)}break;case 4:a=this.channel[0];b=this.channel[1];c=this.channel[2];d=this.channel[3];g=a.length;
j=this.redChannel=new (m?Uint8Array:Array)(g);h=this.greenChannel=new (m?Uint8Array:Array)(g);for(var s=this.blueChannel=new (m?Uint8Array:Array)(g),p,w,r,x,y=this.header.depth/8,B,e=B=0;e<g;++B,e+=y)p=255-a[e],w=255-b[e],r=255-c[e],x=255-d[e],j[B]=65535-(p*(255-x)+(x<<8))>>8,h[B]=65535-(w*(255-x)+(x<<8))>>8,s[B]=65535-(r*(255-x)+(x<<8))>>8;break;case 9:a=this.channel[0];b=this.channel[1];c=this.channel[2];e=a.length;g=this.redChannel=new (m?Uint8Array:Array)(e);j=this.greenChannel=new (m?Uint8Array:
Array)(e);h=this.blueChannel=new (m?Uint8Array:Array)(e);s=6/29;w=this.header.depth/8;for(d=p=0;d<e;++p,d+=w)y=((100*a[d]>>8)+16)/116,r=y+(b[d]-128)/500,x=y-(c[d]-128)/200,r=r>s?0.950456*Math.pow(r,3):3*(r-16/116)*Math.pow(s,2),y=y>s?1*Math.pow(y,3):3*(y-16/116)*Math.pow(s,2),x=x>s?1.088754*Math.pow(x,3):3*(x-16/116)*Math.pow(s,2),g[p]=255*Math.pow(2.041588*r-0.565007*y-0.344731*x,1/2.2),j[p]=255*Math.pow(-0.969244*r+1.875968*y+0.041555*x,1/2.2),h[p]=255*Math.pow(0.013444*r-0.118362*y+1.015175*x,
1/2.2)}this.parsed=!0};function R(a){a.parsed||a.parse();return[a.redChannel,a.greenChannel,a.blueChannel,a.alphaChannel]};function S(){}S.prototype.parse=function(a,b){var c;this.offset=a.ip;c=t(a);this.length=c+4;if(b.colorMode===E&&768!==c)throw Error("invalid color mode data");this.data=F(a,c)};function T(){}l(T,J);T.prototype.parse=function(a,b){var c=this.channel=[],d,e=b.channels,g=b.columns*b.rows*(b.depth/8);for(d=0;d<e;++d)c[d]=F(a,g)};function U(){}l(U,J);U.prototype.parse=function(a,b){var c,d=this.channel=[],e=this.lineLength=[],g,j,h=b.rows,s=b.channels,p;for(c=0;c<h*s;++c)e[c]=A(a);for(g=0;g<s;++g){j=[];for(c=p=0;c<h;++c)j[c]=N(a,e[g*h+c]*(b.depth/8)),p+=j[c].length;if(m){d[g]=new Uint8Array(p);p=c=0;for(h=j.length;c<h;++c)d[g].set(j[c],p),p+=j[c].length}else d[g]=Array.prototype.concat.apply([],j)}};function V(){}V.prototype.parse=function(a,b){this.offset=a.ip;this.compressionMethod=A(a);switch(this.compressionMethod){case 0:this.image=new T;break;case 1:this.image=new U;break;default:throw Error("unknown compression method");}this.image.parse(a,b);this.length=a.ip-this.offset};
V.prototype.createCanvas=function(a,b){var c=document.createElement("canvas"),d=c.getContext("2d"),e=c.width=a.columns,g=c.height=a.rows,j,h,s,p,w,r;j=new Q(a,b,this.image.channel);j.parsed||j.parse();r=[j.redChannel,j.greenChannel,j.blueChannel];if(0>=e||0>=g)return null;j=d.createImageData(e,g);h=j.data;for(p=0;p<g;++p)for(s=0;s<e;++s)w=p*e+s,h[4*w]=r[0][w],h[4*w+1]=r[1][w],h[4*w+2]=r[2][w],h[4*w+3]=255;d.putImageData(j,0,0);return c};
V.prototype.createBytes=function(a,b){var c=a.columns,d=a.rows,e,g,j,h;g=R(new Q(a,b,this.image.channel));if(0>=c||0>=d)return null;e=new Uint8ClampedArray(4*c*d);var s=g[0],p=g[1],w=g[2],r=g[3];for(j=0;j<d;++j)for(g=0;g<c;++g)h=j*c+g,e[4*h]=s[h],e[4*h+1]=p[h],e[4*h+2]=w[h],e[4*h+3]=r?r[h]:255;return e};function W(){}W.prototype.parse=function(a){this.offset=a.ip;if("8BIM"!==q(a,4))throw Error("invalid signature");this.identifier=A(a);this.name=q(a,a.input[a.ip++]);this.dataSize=t(a);this.data=F(a,this.dataSize);this.length=a.ip-this.offset};function la(){}la.prototype.parse=function(a){this.offset=a.ip;this.length=t(a)+4;this.imageResource=new W;this.imageResource.parse(a);a.seek(this.offset+this.length,0)};function ma(){}ma.prototype.parse=function(a){var b;this.offset=a.ip;b=t(a);this.length=b+4;0===b?console.log("skip: layer mask data (empty body)"):(this.top=v(a),this.left=v(a),this.bottom=v(a),this.right=v(a),this.defaultColor=z(a),this.flags=z(a),20===b?this.padding=A(a):(this.realFlags=z(a),this.realBackground=z(a),this.top2=v(a),this.left2=v(a),this.bottom2=v(a),this.right2=v(a)))};function na(){this.info=[]}
na.prototype.parse=function(a,b){var c,d;this.offset=a.ip;this.top=v(a);this.left=v(a);this.bottom=v(a);this.right=v(a);this.channels=A(a);c=0;for(d=this.channels;c<d;++c)this.info[c]={id:C(a),length:t(a)};if("8BIM"!==q(a,4))throw Error("invalid blend mode signature");this.blendMode=q(a,4);this.opacity=z(a);this.clipping=z(a);this.flags=z(a);this.filter=z(a);this.extraLength=t(a);c=a.ip+this.extraLength;this.layerMaskData=new ma;this.layerMaskData.parse(a);this.blendingRanges=new K;this.blendingRanges.parse(a);
d=z(a);this.name=q(a,d);a.seek((4-(1+d)%4)%4);for(this.additionalLayerInfo=[];a.ip<c;)d=new n,d.parse(a,b),this.additionalLayerInfo.push(d);this.length=a.ip-this.offset};function X(){}l(X,I);X.prototype.parse=function(a,b,c){this.channel=F(a,c)};function Y(){}l(Y,I);Y.prototype.parse=function(a,b,c){var d=this.lineLength=[],e=[];b=b.bottom-b.top;var g=a.ip+c,j=0;for(c=0;c<b;++c)d[c]=A(a);for(c=0;c<b&&!(e[c]=N(a,d[c]),j+=e[c].length,a.ip>=g);++c);if(m){this.channel=new Uint8Array(j);a=c=0;for(b=e.length;c<b;++c)this.channel.set(e[c],a),a+=e[c].length}else this.channel=Array.prototype.concat.apply([],e)};function Z(){}Z.prototype.parse=function(a,b){var c=this.channel=[],d,e,g,j,h;this.offset=a.ip;e=0;for(g=b.channels;e<g;++e)if(j=a.ip,h=b.info[e],d=A(a),2!==h.length){switch(d){case 0:d=new X;break;case 1:d=new Y;break;default:throw Error("unknown compression method: "+d);}d.parse(a,b,h.length-2);c[e]=d;a.seek(h.length+j,0)}this.length=a.ip-this.offset};
Z.prototype.createCanvas=function(a,b,c){var d=document.createElement("canvas"),e=d.getContext("2d"),g=d.width=c.right-c.left,j=d.height=c.bottom-c.top,h,s,p=this.channel,w=[],r,x,y,B;if(0===g||0===j)return null;h=e.createImageData(g,j);s=h.data;r=0;for(x=p.length;r<x;++r)switch(c.info[r].id){case 0:case 1:case 2:case 3:w[c.info[r].id]=p[r].channel;break;case -1:y=p[r].channel;break;case -2:B=p[r].channel;break;default:console.warn("not supported channel id",c.info[r].id)}y&&w.push(y);p=R(new Q(a,
b,w));for(b=0;b<j;++b)for(a=0;a<g;++a)c=b*g+a,s[4*c+0]=p[0][c],s[4*c+1]=p[1][c],s[4*c+2]=p[2][c],s[4*c+3]=B?B[c]/255*(p[3]?p[3][c]:255):p[3]?p[3][c]:255;e.putImageData(h,0,0);return d};function oa(){this.layerRecord=[];this.channelImageData=[]}oa.prototype.parse=function(a,b){var c,d,e;this.offset=a.ip;this.length=t(a)+4;this.layerCount=Math.abs(C(a));c=0;for(d=this.layerCount;c<d;++c)e=new na,e.parse(a,b),this.layerRecord[c]=e;c=0;for(d=this.layerCount;c<d;++c)e=new Z,e.parse(a,this.layerRecord[c]),this.channelImageData[c]=e;a.seek(this.offset+this.length,0)};function pa(){}pa.prototype.parse=function(a,b){var c;this.offset=a.ip;c=t(a);this.length=c+4;0===c&&console.log("skip: layer and mask information (empty body)");c=a.ip+c;this.layerInfo=new oa;this.globalLayerMaskInfo=new O;this.additionalLayerInfo=new n;this.layerInfo.parse(a,b);this.globalLayerMaskInfo.parse(a,b);this.additionalLayerInfo.parse(a,b);a.seek(c,0)};function $(a,b){b||(b={});this.stream=new L(a,b.inputPosition|0)}$.prototype.parse=function(){var a=this.stream;this.header=new P;this.colorModeData=new S;this.imageResources=new la;this.layerAndMaskInformation=new pa;this.imageData=new V;this.header.parse(a);this.colorModeData.parse(a,this.header);this.imageResources.parse(a);this.layerAndMaskInformation.parse(a,this.header);this.imageData.parse(a,this.header)};k("PSD.Parser",$);k("PSD.Parser.prototype.parse",$.prototype.parse);}).call(this);
